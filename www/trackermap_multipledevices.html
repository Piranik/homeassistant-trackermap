<!DOCTYPE html>
<!-- v.20180217-->
<html>
<head>
<meta charset="UTF-8">
</head>
<script src="https://d3js.org/d3.v4.min.js"></script>
<style>
    html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
    #map {
        height: 100%;
        width: 100%;
        margin-right: 10px;
    }

    #date,
    #date2 {
        background-color: #ffecb3;
        margin-top: 3px;
        border: 1px solid grey;
    }

    #floating-panel {
        position: relative;
        left: 0px;
        padding: 1px;
        border-bottom: 1px solid #999;
        text-align: center;
        font-family: 'Roboto', 'sans-serif';
        line-height: 10px;
        background-color: #fff;
        z-index: 5;
    }

    ::-webkit-datetime-edit-day-field {
        color: red;
    }
</style>
<script>
    function initMap() {

        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 5,
            gestureHandling: 'greedy',
            disableDefaultUI: true,
            mapTypeControl: true,
            mapTypeControlOptions: {
                 style: google.maps.MapTypeControlStyle.DEFAULT,
                 position: google.maps.ControlPosition.TOP_LEFT
            },
            center: {
                lat: 40,
                lng: 0
            }, 
        });
        poly = new google.maps.Polyline({
            strokeOpacity: 0.5,
            strokeWeight: 2
        });
        poly.setMap(map);
      
        heatmapData = new google.maps.MVCArray();
        heatmap = new google.maps.visualization.HeatmapLayer({
            geodesic: false,
            clickable: false,
            data: heatmapData,
            radius: 30,
            opacity: 0.7,
            maxIntensity: 10
        });
/*---------------------------------------------------------------------------- 
  For multiple devices repeat the section below (increasing the number next to the variables).
  You can also change the color of the line (strokeColor: 'blue'). Pay attention to "data: heatmapDatax..."
  ---------------------------------------------------------------------------- */  
        poly2 = new google.maps.Polyline({
            strokeColor: 'blue',
            strokeOpacity: 0.5,
            strokeWeight: 2
        });
        poly2.setMap(map);
      
        heatmapData2 = new google.maps.MVCArray();
        heatmap2 = new google.maps.visualization.HeatmapLayer({
            geodesic: false,
            clickable: false,
            data: heatmapData2,
            radius: 30,
            opacity: 0.7,
            maxIntensity: 10
        });
/*---------------------------------------------------------------------------- */  
    }

    function toggleHeatmap() {
        heatmap.setMap(heatmap.getMap() ? null : map);
        poly.setMap(poly.getMap() ? null : map);
/*---------------------------------------------------------------------------- 
  For multiple devices repeat the section below (increasing the number next to the variables).
  ---------------------------------------------------------------------------- */  
        heatmap2.setMap(heatmap2.getMap() ? null : map);
        poly2.setMap(poly2.getMap() ? null : map);
/*---------------------------------------------------------------------------- */     
    } 

    function changeupRadius() {
        heatmap.set('radius', heatmap.get('radius') * 1.2);
/*---------------------------------------------------------------------------- 
  For multiple devices repeat the section below (increasing the number next to the variables).
  ---------------------------------------------------------------------------- */  
        heatmap2.set('radius', heatmap2.get('radius') * 1.2);
/*---------------------------------------------------------------------------- */       
    }

    function changedownRadius() {
        heatmap.set('radius', heatmap.get('radius') / 1.2);
/*---------------------------------------------------------------------------- 
  For multiple devices repeat the section below (increasing the number next to the variables).
  ---------------------------------------------------------------------------- */  
        heatmap2.set('radius', heatmap2.get('radius') / 1.2);
/*---------------------------------------------------------------------------- */ 
    }

    function changeupInt() {
        heatmap.set('maxIntensity', heatmap.get('maxIntensity') / 1.2);
/*---------------------------------------------------------------------------- 
  For multiple devices repeat the section below (increasing the number next to the variables).
  ---------------------------------------------------------------------------- */  
        heatmap2.set('maxIntensity', heatmap2.get('maxIntensity') / 1.2);
/*---------------------------------------------------------------------------- */ 
    }

    function changedownInt() {
        heatmap.set('maxIntensity', heatmap.get('maxIntensity') * 1.2);
/*---------------------------------------------------------------------------- 
  For multiple devices repeat the section below (increasing the number next to the variables).
  ---------------------------------------------------------------------------- */  
        heatmap2.set('maxIntensity', heatmap2.get('maxIntensity') * 1.2);
/*---------------------------------------------------------------------------- */ 
    }

    function changeOpacity() {
        heatmap.set('opacity', heatmap.get('opacity') ? null : 0.8);
/*---------------------------------------------------------------------------- 
  For multiple devices repeat the section below (increasing the number next to the variables).
  ---------------------------------------------------------------------------- */  
        heatmap2.set('opacity', heatmap2.get('opacity') ? null : 0.8);
/*---------------------------------------------------------------------------- */ 
    }
    function changeGradient() {
        var gradient = [
          'rgba(0, 255, 255, 0)',
          'rgba(0, 255, 255, 1)',
          'rgba(0, 191, 255, 1)',
          'rgba(0, 127, 255, 1)',
          'rgba(0, 63, 255, 1)',
          'rgba(0, 0, 255, 1)',
          'rgba(0, 0, 223, 1)',
          'rgba(0, 0, 191, 1)',
          'rgba(0, 0, 159, 1)',
          'rgba(0, 0, 127, 1)',
          'rgba(63, 0, 91, 1)',
          'rgba(127, 0, 63, 1)',
          'rgba(191, 0, 31, 1)',
          'rgba(255, 0, 0, 1)'
        ]
        heatmap.set('gradient', heatmap.get('gradient') ? null : gradient);
/*---------------------------------------------------------------------------- 
  For multiple devices repeat the section below (increasing the number next to the variables).
  ---------------------------------------------------------------------------- */  
        heatmap2.set('gradient', heatmap2.get('gradient') ? null : gradient);
/*---------------------------------------------------------------------------- */ 
    }
    var myVar = setInterval(addLatLng, 700);
    var myVar1 = setInterval(addLatLng, 600000);
    var myVar2 = setInterval(today, 100);

    function addLatLng(event) {

        var URLMarker = document.getElementById("marker").value
        //Replace here
                var URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vScr0e6EJvC8nUXF0Q3BMz2ebMpz5TCKv6vLgiL2CIkjerHJn62ukFMOUSO5qeAcQptr4dD_AFXF2Zq/pub?gid=0&single=true&output=csv';

        d3.csv(URL, function(error, data) {
/*---------------------------------------------------------------------------- 
  For multiple devices add an csv3, csv4... in the 'if' below, replacing the e.g row['Device'] === "John" with other options from the select form.
  In the else section also add csv3 = csv etc.
  ---------------------------------------------------------------------------- */  
            if (document.getElementById("device").value === "All") {
            csv = data.filter(function(row) {
                return (row['Date'] >= document.getElementById("date").value && row['Date'] <= document.getElementById("date2").value && row['Device'] === "John" );
            });
          
            csv2 = data.filter(function(row) {
                return (row['Date'] >= document.getElementById("date").value && row['Date'] <= document.getElementById("date2").value && row['Device'] === "Mary" );
            });
            }
          
            else {
            csv = data.filter(function(row) {
                return (row['Date'] >= document.getElementById("date").value && row['Date'] <= document.getElementById("date2").value && row['Device'] === document.getElementById("device").value );
            });
          
            csv2 = csv;
            }
/*---------------------------------------------------------------------------- */
          
            var bounds = new google.maps.LatLngBounds();
           
            csv.forEach(function(d) {

                var location = new google.maps.LatLng(d.Lat, d.Long);
                //For debug uncomment the following line:
                //console.log(d[0])
                poly.getPath().push(location);
                poly.set('strokeColor', "green");
              
                heatmapData.push(location);
                var marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: d.Title,
                    icon: URLMarker,
                });
                bounds.extend(location);
                map.fitBounds(bounds);
                marker.infowindow = new google.maps.InfoWindow({
                    content: d.Title
                });
                marker.addListener('click', function() {
                    this.infowindow.open(map, this);
                });
            });
/*---------------------------------------------------------------------------- 
  If more options were added in the CSV above, add multiple functions replacing the variables: csv2, poly2, heatmapData2 with the next number.
  You can also change the color e.g. 'poly3.set('strokeColor', "yellow");
  ---------------------------------------------------------------------------- */           
            csv2.forEach(function(d) {

                var location = new google.maps.LatLng(d.Lat, d.Long);
                poly2.getPath().push(location);
                poly2.set('strokeColor', "red");
              
                heatmapData2.push(location);
                var marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: d.Title,
                    icon: URLMarker,
                });
                bounds.extend(location);
                map.fitBounds(bounds);
                marker.infowindow = new google.maps.InfoWindow({
                    content: d.Title
                });
                marker.addListener('click', function() {
                    this.infowindow.open(map, this);
                });
            });
/*---------------------------------------------------------------------------- */
        });
      
        clearInterval(myVar);

    }
    function today() {
        var nd = new Date();
        var ndoff = new Date (+nd-nd.getTimezoneOffset()*60000);
        document.getElementById('date').valueAsDate = ndoff;
        document.getElementById('date2').valueAsDate = ndoff;
        clearInterval(myVar2);
        var testdate = document.getElementById('date').value;
        console.log(testdate  + "v.20180217")
    }
    function min1() {
        var dd = document.getElementById('date').value;
        var nd = new Date(dd);
        nd.setDate(nd.getDate() - 1);
        var ndoff = new Date (+nd-nd.getTimezoneOffset()*60000);
        document.getElementById('date').valueAsDate = ndoff;
        document.getElementById('date2').valueAsDate = ndoff;
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXu3BoAwbEF8w27rTSIAs-l183ACb3v_M&libraries=visualization&callback=initMap">
</script>
<div id="floating-panel">
    <select id="marker" onChange="initMap(), addLatLng()">
    <option selected disabled value="https://maps.gstatic.com/mapfiles/ridefinder-images/mm_20_red.png">Markers</option>
    <option value="https://maps.gstatic.com/mapfiles/ridefinder-images/mm_20_red.png">Yes</option>
    <option value="0">No</option>
    </select>
<!-- ---------------------------------------------------------------------------- 
Modify the section below with your device name. You can also add more options.
The first option is the initial value. You can replace it with a device, however you also need to keep the "All" option.
     ---------------------------------------------------------------------------- -->  
    <select id="device" onChange="initMap(), addLatLng()">
    <option selected value="All">All</option>
    <option value="Mary">Mary</option>
    <option value="John">John</option>
    </select>
<!-- ---------------------------------------------------------------------------- -->  
        <button onclick="toggleHeatmap()">Toggle Heatmap</button></br>
        <button onclick="changeupRadius()">▲ Radius</button>
        <button onclick="changedownRadius()">▼ Radius</button>
        <button onclick="changeupInt()">▲ Int</button>
        <button onclick="changedownInt()">▼ Int</button>
        <button onclick="changeGradient()">Color</button>
        <button onclick="changeOpacity()">Opacity</button>
    <br>
    <input id="date" type="date" required pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}" title="yyyy-mm-dd" onChange="initMap(), addLatLng()">
    <input id="date2" type="date" required pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}" title="yyyy-mm-dd" onChange="initMap(), addLatLng()">
    <input type="button" value="Today" onClick="today(),initMap(), addLatLng()">
    <input type="button" value="-1D" onClick="min1(),initMap(), addLatLng()"></div>
<div id="map"></div>
</html>
